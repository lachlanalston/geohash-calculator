<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Geohash Calculator</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = { darkMode: 'class' }
</script>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  #map { height: 600px; border-radius: 0.5rem; background-color: #1f2937; }
  #suggestions { position: absolute; z-index: 50; width: calc(100% - 2rem); }
  .dark #suggestions { background-color: #1f2937; color: #f9fafb; border-color: #374151; }
</style>
</head>
<body class="bg-gray-900 text-gray-100 dark:bg-gray-900 dark:text-gray-100">

<div class="max-w-7xl mx-auto p-6 flex flex-col md:flex-row gap-6 relative">

  <!-- Left Panel: Inputs & Output -->
  <div class="flex-shrink-0 w-full md:w-96 space-y-6">
    <div class="bg-gray-800 shadow-lg rounded-lg p-6 space-y-4 relative">
      <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold text-center flex-1">Geohash Calculator</h1>
        <button id="darkToggle" class="ml-2 bg-gray-600 px-3 py-1 rounded hover:bg-gray-500 transition">Toggle Theme</button>
      </div>
      <button id="getLocation" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition">Use My GPS Location</button>
      
      <div>
        <h2 class="text-lg font-semibold mb-2">Coordinates</h2>
        <input type="text" id="latitude" placeholder="Latitude" class="w-full border rounded px-3 py-2 mb-2 focus:ring-2 focus:ring-blue-500 focus:outline-none bg-gray-900 text-gray-100 border-gray-700">
        <input type="text" id="longitude" placeholder="Longitude" class="w-full border rounded px-3 py-2 mb-2 focus:ring-2 focus:ring-blue-500 focus:outline-none bg-gray-900 text-gray-100 border-gray-700">
        <button id="calculateCoords" class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700 transition">Calculate</button>
      </div>

      <div class="relative">
        <h2 class="text-lg font-semibold mb-2">Location Name</h2>
        <input type="text" id="locationName" placeholder="e.g. Sydney, Australia" class="w-full border rounded px-3 py-2 mb-2 focus:ring-2 focus:ring-purple-500 focus:outline-none bg-gray-900 text-gray-100 border-gray-700" autocomplete="off">
        <ul id="suggestions" class="bg-gray-800 border border-gray-700 rounded max-h-40 overflow-auto hidden"></ul>
        <button id="calculateLocation" class="w-full bg-purple-600 text-white py-2 rounded-md hover:bg-purple-700 transition mt-2">Calculate</button>
      </div>

      <div>
        <h2 class="text-lg font-semibold mb-2">Geohash Input</h2>
        <input type="text" id="geohashInput" placeholder="e.g. r3gx2f9zn" class="w-full border rounded px-3 py-2 mb-2 focus:ring-2 focus:ring-orange-500 focus:outline-none bg-gray-900 text-gray-100 border-gray-700">
        <button id="showGeohash" class="w-full bg-orange-600 text-white py-2 rounded-md hover:bg-orange-700 transition">Show on Map</button>
      </div>
    </div>

    <!-- Output Panel -->
    <div class="bg-gray-800 shadow-lg rounded-lg p-6">
      <h2 class="text-xl font-semibold mb-4">Output</h2>
      <div id="output" class="space-y-1 text-gray-100">
        <p>Results will appear here.</p>
      </div>
    </div>
  </div>

  <!-- Right Panel: Map -->
  <div class="flex-1">
    <div class="bg-gray-800 shadow-lg rounded-lg p-4">
      <div id="map"></div>
    </div>
  </div>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const output = document.getElementById('output');
const BASE32 = "0123456789bcdefghjkmnpqrstuvwxyz";

// Initialize map
const map = L.map('map').setView([0,0], 2);

// Light and dark tile layers
const lightTiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 });
const darkTiles = L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_dark/{z}/{x}/{y}{r}.png', { maxZoom: 20 });

// Add dark tiles by default
darkTiles.addTo(map);

let marker = null;
let boxLayer = null;

// Dark mode toggle
const darkToggle = document.getElementById('darkToggle');
darkToggle.addEventListener('click', () => {
  document.documentElement.classList.toggle('dark'); 
  if(document.documentElement.classList.contains('dark')){
    map.removeLayer(lightTiles);
    darkTiles.addTo(map);
  } else {
    map.removeLayer(darkTiles);
    lightTiles.addTo(map);
  }
  setTimeout(() => map.invalidateSize(), 200);
});

function setMap(lat, lon, bbox=null){
  if(marker) map.removeLayer(marker);
  if(boxLayer) map.removeLayer(boxLayer);
  marker = L.marker([lat, lon]).addTo(map);
  if(bbox){
    boxLayer = L.rectangle([[bbox[0], bbox[1]], [bbox[2], bbox[3]]], {color:"red", weight:2}).addTo(map);
    map.fitBounds([[bbox[0], bbox[1]], [bbox[2], bbox[3]]], {padding:[20,20]});
  } else { map.setView([lat, lon], 14); }
}

// Geohash functions
function encodeGeohash(lat, lon, precision=9){
  let isEven=true, bit=0, ch=0, geohash='';
  let latMin=-90, latMax=90, lonMin=-180, lonMax=180;
  while(geohash.length<precision){
    if(isEven){
      let mid=(lonMin+lonMax)/2;
      if(lon>mid){ch|=(1<<(4-bit)); lonMin=mid;}else{lonMax=mid;}
    } else {
      let mid=(latMin+latMax)/2;
      if(lat>mid){ch|=(1<<(4-bit)); latMin=mid;}else{latMax=mid;}
    }
    isEven=!isEven;
    if(bit<4){bit++;} else {geohash+=BASE32[ch]; bit=0; ch=0;}
  }
  return geohash;
}

function decodeGeohashBBox(geohash){
  let isEven=true, latMin=-90, latMax=90, lonMin=-180, lonMax=180;
  for(let c of geohash){
    let cd=BASE32.indexOf(c);
    for(let mask of [16,8,4,2,1]){
      if(isEven){ let mid=(lonMin+lonMax)/2; if(cd&mask){lonMin=mid;}else{lonMax=mid;} }
      else{ let mid=(latMin+latMax)/2; if(cd&mask){latMin=mid;}else{latMax=mid;} }
      isEven=!isEven;
    }
  }
  return [latMin, lonMin, latMax, lonMax];
}

function geohashNeighbors(geohash){
  const bbox=decodeGeohashBBox(geohash);
  const latDiff=bbox[2]-bbox[0], lonDiff=bbox[3]-bbox[1];
  const latCenter=(bbox[0]+bbox[2])/2, lonCenter=(bbox[1]+bbox[3])/2;
  return {
    n: encodeGeohash(latCenter+latDiff, lonCenter, geohash.length),
    s: encodeGeohash(latCenter-latDiff, lonCenter, geohash.length),
    e: encodeGeohash(latCenter, lonCenter+lonDiff, geohash.length),
    w: encodeGeohash(latCenter, lonCenter-lonDiff, geohash.length),
    ne: encodeGeohash(latCenter+latDiff, lonCenter+lonDiff, geohash.length),
    nw: encodeGeohash(latCenter+latDiff, lonCenter-lonDiff, geohash.length),
    se: encodeGeohash(latCenter-latDiff, lonCenter+lonDiff, geohash.length),
    sw: encodeGeohash(latCenter-latDiff, lonCenter-lonDiff, geohash.length)
  };
}

function displayResult(lat, lon, geohash){
  const bbox=decodeGeohashBBox(geohash);
  const neighbors=geohashNeighbors(geohash);
  output.innerHTML=`
    <p><strong>Geohash:</strong> ${geohash}</p>
    <p><strong>Latitude:</strong> ${lat.toFixed(6)}</p>
    <p><strong>Longitude:</strong> ${lon.toFixed(6)}</p>
    <p><strong>Bounding Box:</strong> SW(${bbox[0].toFixed(6)}, ${bbox[1].toFixed(6)}), NE(${bbox[2].toFixed(6)}, ${bbox[3].toFixed(6)})</p>
    <p><strong>Neighbors:</strong> N:${neighbors.n}, NE:${neighbors.ne}, E:${neighbors.e}, SE:${neighbors.se}, S:${neighbors.s}, SW:${neighbors.sw}, W:${neighbors.w}, NW:${neighbors.nw}</p>
  `;
  setMap(lat, lon, bbox);
}

// Event listeners for buttons
document.getElementById('getLocation').addEventListener('click', ()=>{
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat=pos.coords.latitude, lon=pos.coords.longitude;
      displayResult(lat, lon, encodeGeohash(lat, lon));
    }, err=>{output.innerHTML='Error getting location: '+err.message;});
  } else {output.innerHTML='Geolocation not supported.';}
});

document.getElementById('calculateCoords').addEventListener('click', ()=>{
  const lat=parseFloat(document.getElementById('latitude').value);
  const lon=parseFloat(document.getElementById('longitude').value);
  if(!isNaN(lat)&&!isNaN(lon)){displayResult(lat, lon, encodeGeohash(lat, lon));}
  else{output.innerHTML='Enter valid latitude & longitude.';}
});

document.getElementById('calculateLocation').addEventListener('click', async ()=>{
  const loc=document.getElementById('locationName').value;
  if(!loc){output.innerHTML='Enter location.'; return;}
  try{
    const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(loc)}`);
    const data=await res.json();
    if(data.length===0){output.innerHTML='Location not found.'; return;}
    const lat=parseFloat(data[0].lat), lon=parseFloat(data[0].lon);
    displayResult(lat, lon, encodeGeohash(lat, lon));
  } catch(err){output.innerHTML='Error fetching location: '+err.message;}
});

document.getElementById('showGeohash').addEventListener('click', ()=>{
  const hash=document.getElementById('geohashInput').value;
  if(!hash){output.innerHTML='Enter geohash.'; return;}
  const bbox=decodeGeohashBBox(hash);
  const lat=(bbox[0]+bbox[2])/2, lon=(bbox[1]+bbox[3])/2;
  displayResult(lat, lon, hash);
});

// Map click listener
map.on('click', function(e) {
  const lat = e.latlng.lat;
  const lon = e.latlng.lng;
  const geohash = encodeGeohash(lat, lon);

  document.getElementById('latitude').value = lat.toFixed(6);
  document.getElementById('longitude').value = lon.toFixed(6);
  document.getElementById('geohashInput').value = geohash;

  displayResult(lat, lon, geohash);
});

// Location autocomplete
const locationInput = document.getElementById('locationName');
const suggestions = document.getElementById('suggestions');

locationInput.addEventListener('input', async () => {
  const query = locationInput.value;
  if(!query) { suggestions.innerHTML=''; suggestions.classList.add('hidden'); return; }

  try {
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`);
    const data = await res.json();
    suggestions.innerHTML = data.map(item => `<li class="px-3 py-2 hover:bg-purple-100 cursor-pointer dark:hover:bg-purple-700" data-lat="${item.lat}" data-lon="${item.lon}">${item.display_name}</li>`).join('');
    suggestions.classList.remove('hidden');
  } catch(err) { console.error(err); }
});

suggestions.addEventListener('click', e => {
  if(e.target.tagName === 'LI') {
    const lat = parseFloat(e.target.dataset.lat);
    const lon = parseFloat(e.target.dataset.lon);
    locationInput.value = e.target.textContent;
    suggestions.classList.add('hidden');
    displayResult(lat, lon, encodeGeohash(lat, lon));
  }
});

// Hide suggestions when clicking outside
document.addEventListener('click', e => {
  if(!locationInput.contains(e.target) && !suggestions.contains(e.target)) {
    suggestions.classList.add('hidden');
  }
});
</script>
</body>
</html>
